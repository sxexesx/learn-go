## Стэк и куча

Память поделена на две части исторически. Куча начинается с начала, стек с конца. В protected area нельзя аллоцировать никакие объекты. Когда стек дорастает до protected area происходит stack overflow.  

<img src="./_src/pic_1.png">

Stack быстрее и свобождается автоматически и быстрее. Из кучи (heap) сами объекты не удаляются, нужно либо удалять руками, либо с помощью Garbage Collector. 

В стэке храняться недолго живущие локальные переменные. В куче храняться объекты и ссылки, которые живут за пределами функции.

## Стэк в Go

Каждой горутине выделяется собственный стэк. Берется он у системы (syscom) у специальной области памяти, которую можно шарить между потоками. Стеки условно бесконечные (1GB - x64, 256Mb - x32), но базовый/начальный размер стека - 2Кб. 

Не каждая переменная будет создана на стеке. За это отвечает escape analysis.

```golang
package main

func main() {
    foo()
}

func foo() {
    bar()
}

func bar() {
    b := 10
}
```
<img src="./_src/pic_2.png">

**Stack pointer** - указатель, который показывает в каком состоянии сейчас находится стэк. В стеки записываются **function frame**, в которых указан возвращаемый адрес, адрес предыдущего фрейма, локальные переменные. 

Если runtime видит, что новый frame function переполяет базовые 2Кб, тогда он выделяет новую область памяти и копирует все старые function frame'ы и новый. Старый стек удаляется.
